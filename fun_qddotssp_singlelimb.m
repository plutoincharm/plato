function qddot = fun_qddotssp_singlelimb(x,u,dt)
%%%% SSP phase- 2   %%%%%%%%%%%%%%


global A B Nx Nu pert MI L m nx ny tx ty g  r lam  vars misc alp indic kc lamall xdata lamx lamy af acal


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

m1 = m(1);
m2 = m(2);
m3 = m(3);
m4 = m(4);


L2 = L(1);
L3 = L(2);



r2 = r(1);
r3 = r(2);


MI1 = MI(1);
MI2 = MI(2);
MI3 = MI(3);
MI4 = MI(4);

R2 = misc(1);
R3 = misc(2);
%R2 = 0.4028;
%R3 = 0.4061;
del2 = misc(3);
del3 = misc(4);
%del2 = deg2rad(1.142);
%del3 = deg2rad(1.20);
gamma61 = misc(5);
gamma62 = misc(6);
gamma71 = misc(7);
gamma72 = misc(8);
r4 = vars(1);
r7 = vars(2);
r4t = vars(3);
r4h = vars(4);



%{
tht4 = xdata(1);
x1   = xdata(2);
y1   = xdata(3);
omg4 = xdata(4);
vhx = xdata(5);
vhy = xdata(5);
alp4 = alp(4);
ax1 =  alp(8);
ay1 =  alp(9);
%T1  = u(1);
T4  = u(1);
%}

tht1 = x(1);
tht2 = x(2);
tht3 = x(3);
tht4 = x(4);
x1   = x(5);
y1   = x(6);

omg1 = x(7);
omg2 = x(8);
omg3 = x(9);
omg4 = x(10);
vhx = x(11);
vhy = x(12);

%{
alp4 = alp(4);
ax1 =  alp(8);
ay1 =  alp(9);
%}
T2  = u(1);
T3  = u(2);
T4  = u(3);



alp1 = alp(1);
alp2 = alp(2);
alp3 = alp(3);
alp4 = alp(4);
ax1 =  alp(5);
ay1 =  alp(6);

x
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Finding external forces
Ass1=[0,(-1),0,(-1);(-1),0,(-1),0;r4.*cos(tht4)+(-1).*r4t.*cos(gamma62+ ...
  tht4),(-1).*r4.*sin(tht4)+r4t.*sin(gamma62+tht4),r4.*cos(tht4)+( ...
  -1).*r4h.*cos(gamma61+tht4),(-1).*r4.*sin(tht4)+r4h.*sin(gamma61+ ...
  tht4);(m1+m2+m3+m4).^(-1).*((-1).*L3.*m3.*cos(tht3)+m3.*r3.*cos( ...
  tht3)+(-1).*m3.*r4.*cos(tht4)+m3.*r4t.*cos(gamma62+tht4)+m4.*r4t.* ...
  cos(gamma62+tht4)+m1.*((-1).*R2.*cos(del2+(-1).*tht1)+(-1).*L2.* ...
  cos(tht2)+(-1).*L3.*cos(tht3)+(-1).*r4.*cos(tht4)+r4t.*cos( ...
  gamma62+tht4))+m2.*((-1).*L2.*cos(tht2)+r2.*cos(tht2)+(-1).*L3.* ...
  cos(tht3)+(-1).*r4.*cos(tht4)+r4t.*cos(gamma62+tht4))),0,(m1+m2+ ...
  m3+m4).^(-1).*((-1).*L3.*m3.*cos(tht3)+m3.*r3.*cos(tht3)+(-1).* ...
  m3.*r4.*cos(tht4)+m3.*r4h.*cos(gamma61+tht4)+m4.*r4h.*cos(gamma61+ ...
  tht4)+m1.*((-1).*R2.*cos(del2+(-1).*tht1)+(-1).*L2.*cos(tht2)+(-1) ...
  .*L3.*cos(tht3)+(-1).*r4.*cos(tht4)+r4h.*cos(gamma61+tht4))+m2.*(( ...
  -1).*L2.*cos(tht2)+r2.*cos(tht2)+(-1).*L3.*cos(tht3)+(-1).*r4.* ...
  cos(tht4)+r4h.*cos(gamma61+tht4))),0]


bss1=[(-1).*ax1.*m1+(-1).*m2.*(ax1+R2.*(omg1.^2.*cos(del2+(-1).*tht1)+( ...
  -1).*alp1.*sin(del2+(-1).*tht1))+r2.*(omg2.^2.*cos(tht2)+alp2.* ...
  sin(tht2)))+(-1).*m3.*(ax1+L2.*omg2.^2.*cos(tht2)+omg3.^2.*r3.* ...
  cos(tht3)+R2.*(omg1.^2.*cos(del2+(-1).*tht1)+(-1).*alp1.*sin(del2+ ...
  (-1).*tht1))+alp2.*L2.*sin(tht2)+alp3.*r3.*sin(tht3))+(-1).*m4.*( ...
  ax1+L2.*omg2.^2.*cos(tht2)+L3.*omg3.^2.*cos(tht3)+omg4.^2.*r4.* ...
  cos(tht4)+R2.*(omg1.^2.*cos(del2+(-1).*tht1)+(-1).*alp1.*sin(del2+ ...
  (-1).*tht1))+alp2.*L2.*sin(tht2)+alp3.*L3.*sin(tht3)+alp4.*r4.* ...
  sin(tht4)),(-1).*ay1.*m1+(-1).*g.*m1+(-1).*g.*m2+(-1).*g.*m3+(-1) ...
  .*g.*m4+(-1).*m2.*(ay1+(-1).*R2.*(alp1.*cos(del2+(-1).*tht1)+ ...
  omg1.^2.*sin(del2+(-1).*tht1))+r2.*((-1).*alp2.*cos(tht2)+ ...
  omg2.^2.*sin(tht2)))+(-1).*m3.*(ay1+(-1).*alp2.*L2.*cos(tht2)+(-1) ...
  .*alp3.*r3.*cos(tht3)+(-1).*R2.*(alp1.*cos(del2+(-1).*tht1)+ ...
  omg1.^2.*sin(del2+(-1).*tht1))+L2.*omg2.^2.*sin(tht2)+omg3.^2.* ...
  r3.*sin(tht3))+(-1).*m4.*(ay1+(-1).*alp2.*L2.*cos(tht2)+(-1).* ...
  alp3.*L3.*cos(tht3)+(-1).*alp4.*r4.*cos(tht4)+(-1).*R2.*(alp1.* ...
  cos(del2+(-1).*tht1)+omg1.^2.*sin(del2+(-1).*tht1))+L2.*omg2.^2.* ...
  sin(tht2)+L3.*omg3.^2.*sin(tht3)+omg4.^2.*r4.*sin(tht4)),(-1).* ...
  alp4.*MI4+T4+(-1).*m4.*r4.*(alp4.*r4+alp2.*L2.*cos(tht2+(-1).* ...
  tht4)+alp3.*L3.*cos(tht3+(-1).*tht4)+(-1).*ay1.*cos(tht4)+(-1).* ...
  g.*cos(tht4)+alp1.*R2.*cos(del2+(-1).*tht1+tht4)+(-1).*L2.* ...
  omg2.^2.*sin(tht2+(-1).*tht4)+(-1).*L3.*omg3.^2.*sin(tht3+(-1).* ...
  tht4)+ax1.*sin(tht4)+omg1.^2.*R2.*sin(del2+(-1).*tht1+tht4)), ...
  alp1.*MI1+alp2.*MI2+alp3.*MI3+alp4.*MI4+(-1).*ax1.*m1.*y1+(ay1+g) ...
  .*m1.*(m1+m2+m3+m4).^(-1).*(m2.*R2.*cos(del2+(-1).*tht1)+m3.*R2.* ...
  cos(del2+(-1).*tht1)+m4.*R2.*cos(del2+(-1).*tht1)+L2.*(m3+m4).* ...
  cos(tht2)+m2.*r2.*cos(tht2)+L3.*m4.*cos(tht3)+m3.*r3.*cos(tht3)+ ...
  m4.*r4.*cos(tht4))+(-1).*m2.*(m1+m2+m3+m4).^(-1).*((-1).*m1.*R2.* ...
  cos(del2+(-1).*tht1)+L2.*(m3+m4).*cos(tht2)+(-1).*m1.*r2.*cos( ...
  tht2)+(-1).*m3.*r2.*cos(tht2)+(-1).*m4.*r2.*cos(tht2)+L3.*m4.*cos( ...
  tht3)+m3.*r3.*cos(tht3)+m4.*r4.*cos(tht4)).*((-1).*ay1+(-1).*g+ ...
  alp2.*r2.*cos(tht2)+R2.*(alp1.*cos(del2+(-1).*tht1)+omg1.^2.*sin( ...
  del2+(-1).*tht1))+(-1).*omg2.^2.*r2.*sin(tht2))+(-1).*m2.*(y1+R2.* ...
  sin(del2+(-1).*tht1)+(-1).*r2.*sin(tht2)).*(ax1+R2.*(omg1.^2.*cos( ...
  del2+(-1).*tht1)+(-1).*alp1.*sin(del2+(-1).*tht1))+r2.*(omg2.^2.* ...
  cos(tht2)+alp2.*sin(tht2)))+m3.*((-1).*y1+(-1).*R2.*sin(del2+(-1) ...
  .*tht1)+L2.*sin(tht2)+r3.*sin(tht3)).*(ax1+L2.*omg2.^2.*cos(tht2)+ ...
  omg3.^2.*r3.*cos(tht3)+R2.*(omg1.^2.*cos(del2+(-1).*tht1)+(-1).* ...
  alp1.*sin(del2+(-1).*tht1))+alp2.*L2.*sin(tht2)+alp3.*r3.*sin( ...
  tht3))+m3.*(m1+m2+m3+m4).^(-1).*(m1.*R2.*cos(del2+(-1).*tht1)+L2.* ...
  (m1+m2).*cos(tht2)+(-1).*m2.*r2.*cos(tht2)+(-1).*L3.*m4.*cos(tht3) ...
  +m1.*r3.*cos(tht3)+m2.*r3.*cos(tht3)+m4.*r3.*cos(tht3)+(-1).*m4.* ...
  r4.*cos(tht4)).*((-1).*ay1+(-1).*g+alp2.*L2.*cos(tht2)+alp3.*r3.* ...
  cos(tht3)+R2.*(alp1.*cos(del2+(-1).*tht1)+omg1.^2.*sin(del2+(-1).* ...
  tht1))+(-1).*L2.*omg2.^2.*sin(tht2)+(-1).*omg3.^2.*r3.*sin(tht3))+ ...
  m4.*((-1).*y1+(-1).*R2.*sin(del2+(-1).*tht1)+L2.*sin(tht2)+L3.* ...
  sin(tht3)+r4.*sin(tht4)).*(ax1+L2.*omg2.^2.*cos(tht2)+L3.* ...
  omg3.^2.*cos(tht3)+omg4.^2.*r4.*cos(tht4)+R2.*(omg1.^2.*cos(del2+( ...
  -1).*tht1)+(-1).*alp1.*sin(del2+(-1).*tht1))+alp2.*L2.*sin(tht2)+ ...
  alp3.*L3.*sin(tht3)+alp4.*r4.*sin(tht4))+m4.*(m1+m2+m3+m4).^(-1).* ...
  (m1.*R2.*cos(del2+(-1).*tht1)+L2.*(m1+m2).*cos(tht2)+(-1).*m2.* ...
  r2.*cos(tht2)+L3.*(m1+m2+m3).*cos(tht3)+(-1).*m3.*r3.*cos(tht3)+ ...
  m1.*r4.*cos(tht4)+m2.*r4.*cos(tht4)+m3.*r4.*cos(tht4)).*((-1).* ...
  ay1+(-1).*g+alp2.*L2.*cos(tht2)+alp3.*L3.*cos(tht3)+alp4.*r4.*cos( ...
  tht4)+R2.*(alp1.*cos(del2+(-1).*tht1)+omg1.^2.*sin(del2+(-1).* ...
  tht1))+(-1).*L2.*omg2.^2.*sin(tht2)+(-1).*L3.*omg3.^2.*sin(tht3)+( ...
  -1).*omg4.^2.*r4.*sin(tht4))]




%bss1 = [bss11;bss12;bss13;bss14;bss15;bss16;bss17;bss18;bss19;bss20]

Assinv = inv(Ass1)
sol = Ass1\bss1'
%fvars = [sol ; det(Ass2)];



lam1 = sol(1);
lam2 = sol(2);
lam3 = sol(3);
lam4 = sol(4);

%{
lamn = sol(1) + sol(3);
lamt = sol(2) + sol(4);
lam1 = lamn/2;
lam3 = lamn/2;
lam2 = lamt/2;
lam4 = lamt/2;
%}



%{
if (indic ==15)
    lam1 = lamall(1,kc);
    lam2 = lamall(2,kc);
    lam3 = lamall(3,kc);  
    lam4 = lamall(4,kc);
    
end
%}
%taking torque values from calculation
%{
T2  = sol(5);
T3  = sol(6);
T4  = sol(7);
T5  = sol(8);
T6  = sol(9);
T7  = sol(10);
%}  

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Mmat=[(-1).*m2.*R2.*sin(del2+(-1).*tht1)+(-1).*m3.*R2.*sin(del2+(-1).* ...
  tht1)+(-1).*m4.*R2.*sin(del2+(-1).*tht1),L2.*m3.*sin(tht2)+L2.* ...
  m4.*sin(tht2)+m2.*r2.*sin(tht2),L3.*m4.*sin(tht3)+m3.*r3.*sin( ...
  tht3),m4.*r4.*sin(tht4),m1+m2+m3+m4,0;(-1).*m2.*R2.*cos(del2+(-1) ...
  .*tht1)+(-1).*m3.*R2.*cos(del2+(-1).*tht1)+(-1).*m4.*R2.*cos(del2+ ...
  (-1).*tht1),(-1).*L2.*m3.*cos(tht2)+(-1).*L2.*m4.*cos(tht2)+(-1).* ...
  m2.*r2.*cos(tht2),(-1).*L3.*m4.*cos(tht3)+(-1).*m3.*r3.*cos(tht3), ...
  (-1).*m4.*r4.*cos(tht4),0,m1+m2+m3+m4;MI1+(m2+m3+m4).*R2.^2,L2.* ...
  m3.*R2.*cos(del2+(-1).*tht1+tht2)+L2.*m4.*R2.*cos(del2+(-1).*tht1+ ...
  tht2)+m2.*r2.*R2.*cos(del2+(-1).*tht1+tht2),L3.*m4.*R2.*cos(del2+( ...
  -1).*tht1+tht3)+m3.*R2.*r3.*cos(del2+(-1).*tht1+tht3),m4.*R2.*r4.* ...
  cos(del2+(-1).*tht1+tht4),(-1).*m2.*R2.*sin(del2+(-1).*tht1)+(-1) ...
  .*m3.*R2.*sin(del2+(-1).*tht1)+(-1).*m4.*R2.*sin(del2+(-1).*tht1), ...
  (-1).*m2.*R2.*cos(del2+(-1).*tht1)+(-1).*m3.*R2.*cos(del2+(-1).* ...
  tht1)+(-1).*m4.*R2.*cos(del2+(-1).*tht1);L2.*m3.*R2.*cos(del2+(-1) ...
  .*tht1+tht2)+L2.*m4.*R2.*cos(del2+(-1).*tht1+tht2)+m2.*r2.*R2.* ...
  cos(del2+(-1).*tht1+tht2),L2.^2.*(m3+m4)+MI2+m2.*r2.^2,L2.*L3.* ...
  m4.*cos(tht2+(-1).*tht3)+L2.*m3.*r3.*cos(tht2+(-1).*tht3),L2.*m4.* ...
  r4.*cos(tht2+(-1).*tht4),L2.*m3.*sin(tht2)+L2.*m4.*sin(tht2)+m2.* ...
  r2.*sin(tht2),(-1).*L2.*m3.*cos(tht2)+(-1).*L2.*m4.*cos(tht2)+(-1) ...
  .*m2.*r2.*cos(tht2);L3.*m4.*R2.*cos(del2+(-1).*tht1+tht3)+m3.*R2.* ...
  r3.*cos(del2+(-1).*tht1+tht3),L2.*L3.*m4.*cos(tht2+(-1).*tht3)+ ...
  L2.*m3.*r3.*cos(tht2+(-1).*tht3),L3.^2.*m4+MI3+m3.*r3.^2,L3.*m4.* ...
  r4.*cos(tht3+(-1).*tht4),L3.*m4.*sin(tht3)+m3.*r3.*sin(tht3),(-1) ...
  .*L3.*m4.*cos(tht3)+(-1).*m3.*r3.*cos(tht3);m4.*R2.*r4.*cos(del2+( ...
  -1).*tht1+tht4),L2.*m4.*r4.*cos(tht2+(-1).*tht4),L3.*m4.*r4.*cos( ...
  tht3+(-1).*tht4),MI4+m4.*r4.^2,m4.*r4.*sin(tht4),(-1).*m4.*r4.* ...
  cos(tht4)]






%%%%%%%%%%%%%%%%%%%%%

%}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%}

%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%% phi is for finding qddot with ext lambda calculation 
phi=[lam2+lam4+(-1).*m2.*omg1.^2.*R2.*cos(del2+(-1).*tht1)+(-1).*m3.* ...
  omg1.^2.*R2.*cos(del2+(-1).*tht1)+(-1).*m4.*omg1.^2.*R2.*cos(del2+ ...
  (-1).*tht1)+(-1).*L2.*m3.*omg2.^2.*cos(tht2)+(-1).*L2.*m4.* ...
  omg2.^2.*cos(tht2)+(-1).*m2.*omg2.^2.*r2.*cos(tht2)+(-1).*L3.*m4.* ...
  omg3.^2.*cos(tht3)+(-1).*m3.*omg3.^2.*r3.*cos(tht3)+(-1).*m4.* ...
  omg4.^2.*r4.*cos(tht4),lam1+lam3+(-1).*g.*m1+(-1).*g.*m2+(-1).*g.* ...
  m3+(-1).*g.*m4+m2.*omg1.^2.*R2.*sin(del2+(-1).*tht1)+m3.*omg1.^2.* ...
  R2.*sin(del2+(-1).*tht1)+m4.*omg1.^2.*R2.*sin(del2+(-1).*tht1)+( ...
  -1).*L2.*m3.*omg2.^2.*sin(tht2)+(-1).*L2.*m4.*omg2.^2.*sin(tht2)+( ...
  -1).*m2.*omg2.^2.*r2.*sin(tht2)+(-1).*L3.*m4.*omg3.^2.*sin(tht3)+( ...
  -1).*m3.*omg3.^2.*r3.*sin(tht3)+(-1).*m4.*omg4.^2.*r4.*sin(tht4),( ...
  -1).*T2+(-1).*lam1.*R2.*cos(del2+(-1).*tht1)+(-1).*lam3.*R2.*cos( ...
  del2+(-1).*tht1)+g.*m2.*R2.*cos(del2+(-1).*tht1)+g.*m3.*R2.*cos( ...
  del2+(-1).*tht1)+g.*m4.*R2.*cos(del2+(-1).*tht1)+(-1).*lam2.*R2.* ...
  sin(del2+(-1).*tht1)+(-1).*lam4.*R2.*sin(del2+(-1).*tht1)+L2.*m3.* ...
  omg2.^2.*R2.*sin(del2+(-1).*tht1+tht2)+L2.*m4.*omg2.^2.*R2.*sin( ...
  del2+(-1).*tht1+tht2)+m2.*omg2.^2.*r2.*R2.*sin(del2+(-1).*tht1+ ...
  tht2)+L3.*m4.*omg3.^2.*R2.*sin(del2+(-1).*tht1+tht3)+m3.*omg3.^2.* ...
  R2.*r3.*sin(del2+(-1).*tht1+tht3)+m4.*omg4.^2.*R2.*r4.*sin(del2+( ...
  -1).*tht1+tht4),T2+(-1).*T3+(-1).*L2.*lam1.*cos(tht2)+(-1).*L2.* ...
  lam3.*cos(tht2)+g.*L2.*m3.*cos(tht2)+g.*L2.*m4.*cos(tht2)+g.*m2.* ...
  r2.*cos(tht2)+L2.*lam2.*sin(tht2)+L2.*lam4.*sin(tht2)+(-1).*L2.* ...
  m3.*omg1.^2.*R2.*sin(del2+(-1).*tht1+tht2)+(-1).*L2.*m4.*omg1.^2.* ...
  R2.*sin(del2+(-1).*tht1+tht2)+(-1).*m2.*omg1.^2.*r2.*R2.*sin(del2+ ...
  (-1).*tht1+tht2)+(-1).*L2.*L3.*m4.*omg3.^2.*sin(tht2+(-1).*tht3)+( ...
  -1).*L2.*m3.*omg3.^2.*r3.*sin(tht2+(-1).*tht3)+(-1).*L2.*m4.* ...
  omg4.^2.*r4.*sin(tht2+(-1).*tht4),T3+(-1).*T4+(-1).*L3.*(lam1+ ...
  lam3).*cos(tht3)+g.*L3.*m4.*cos(tht3)+g.*m3.*r3.*cos(tht3)+L2.* ...
  L3.*m4.*omg2.^2.*sin(tht2+(-1).*tht3)+L2.*m3.*omg2.^2.*r3.*sin( ...
  tht2+(-1).*tht3)+L3.*(lam2+lam4).*sin(tht3)+(-1).*L3.*m4.* ...
  omg1.^2.*R2.*sin(del2+(-1).*tht1+tht3)+(-1).*m3.*omg1.^2.*R2.*r3.* ...
  sin(del2+(-1).*tht1+tht3)+(-1).*L3.*m4.*omg4.^2.*r4.*sin(tht3+(-1) ...
  .*tht4),T4+(-1).*(lam1+lam3).*r4.*cos(tht4)+g.*m4.*r4.*cos(tht4)+ ...
  lam3.*r4h.*cos(gamma61+tht4)+lam1.*r4t.*cos(gamma62+tht4)+L2.*m4.* ...
  omg2.^2.*r4.*sin(tht2+(-1).*tht4)+L3.*m4.*omg3.^2.*r4.*sin(tht3+( ...
  -1).*tht4)+(lam2+lam4).*r4.*sin(tht4)+(-1).*lam4.*r4h.*sin( ...
  gamma61+tht4)+(-1).*lam2.*r4t.*sin(gamma62+tht4)+(-1).*m4.* ...
  omg1.^2.*R2.*r4.*sin(del2+(-1).*tht1+tht4)]




%{
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
NO contact

%}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% For calculating lambda  
%{


%}

%{
%%%%%%%%%%%%%%%%%%%%%%%
inv(Mmat);
qddot = Mmat\phi
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%rhs1 = rhs;
%Cn  = Cmat;
%rhs2 = Gd';


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%rhs2 -gn
%%rhs1 - phi
%Mmat
invM = inv(Mmat)

%Gmat = Cn*invM*Cn';
%invG = inv(Gmat);

%nr  = Gd' - Cn*invM*rhs1';
%P1 = Gd' ;
%P2 = Cn*invM*rhs1';
%lam = Gmat\( Gd'- Cn*invM*rhs1')

lam = [lam1;lam2;lam3;lam4];
%(Cn'*lam + rhs1')
%qddot_invdy = invM*(Cn'*lam + rhs1');
%}

% qddot = qddot_invdy

phi;
qddot_invdy = invM*phi';
acal = qddot_invdy
%alp = invM*phi'
%qddot_invdy(4) = 0
%af = qddot_invdy;
%qddot = [omg1;omg2;omg3;omg4;omg5;omg6;omg7;vhx;vhy;qddot_invdy]
 qddot = qddot_invdy
 %qddot = alp;
 lamx = lam2 + lam4;
 lamy = lam1 + lam3;
% lamx = lamt;
 %lamy = lamn;

end






 






